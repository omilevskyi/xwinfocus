---
name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Run Build and Tests
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # 5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }} # pick PR's HEAD instead of merge commit
          fetch-depth: 0
          show-progress: "false"

      - name: Install dependencies
        run: |
          sudo apt-get update --yes --quiet=2
          sudo apt-get install --yes --quiet=2 --no-install-recommends \
            build-essential libx11-dev libxcb1-dev libxau-dev libxdmcp-dev libcriterion-dev

      - name: Build project
        run: make

      - name: Verify binary
        run: |
          test -f xwinfocus && test -f man/xwinfocus.1.gz && \
            echo "✅ Build succeeded" || (echo "❌ Build failed" && exit 1)

      - name: Workaround for poor GNU cc
        run: ln --symbolic --force --verbose ../include test/include

      - name: Compile test_fringe
        run: cc -std=c99 -lcriterion -o test_fringe test/test_fringe.c fringe.c

      - name: Run test_fringe
        run: ./test_fringe

      - name: Compile test_option_string
        run: cc -std=c99 -lcriterion -o test_option_string test/test_option_string.c option_string.c

      - name: Run test_option_string
        run: ./test_option_string

      - name: Clean up
        run: git --no-pager clean --force -d -x

      # https://github.com/marketplace/actions/conventional-commit-cocogitto-action#reference
      - name: Verify
        if: github.ref != 'refs/heads/main'
        uses: cocogitto/cocogitto-action@c7a74f5406bab86da17da0f0e460a69f8219a68c # 3.11
        with:
          check: false
          check-latest-tag-only: true
          verify: true

      - name: Release
        if: github.ref == 'refs/heads/main'
        uses: cocogitto/cocogitto-action@c7a74f5406bab86da17da0f0e460a69f8219a68c # 3.11
        with:
          git-user: cocogitto
          git-user-email: cocogitto@github.com
          check: false
          check-latest-tag-only: true
          release: true
